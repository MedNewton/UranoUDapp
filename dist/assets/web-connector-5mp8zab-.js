const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/eth_getTransactionCount-CIEBEpFK.js","assets/index-B7UgA71q.js","assets/index-CuOng2Rd.css","assets/in-app-wallet-calls-C9G9WY2D.js","assets/send-batch-transaction-Rzdu1kJj.js"])))=>i.map(i=>d[i]);
import{c6 as g,bP as p,e as w,c7 as S,aj as x,c8 as A,b as I,h as f,_ as b,p as D,aV as V,ah as L,t as $,aR as P,L as Q,c9 as v,ca as N,cb as U,cc as q,cd as H,ce as O,cf as C,cg as J,ch as Y,ci as K,cj as X,ck as Z}from"./index-B7UgA71q.js";import{signLoginPayload as ee}from"./sign-login-payload-BKykauFw.js";import{e as F}from"./eth_sendRawTransaction-DPdnXbFR.js";const k=new Map,te={getItem:async n=>k.get(n)??null,removeItem:async n=>{k.delete(n)},setItem:async(n,e)=>{k.set(n,e)}};async function W({authToken:n,client:e,ecosystem:t}){const r=await p(e,t)(`${g("inAppWallet")}/api/2024-05-05/accounts`,{headers:{Authorization:`Bearer embedded-wallet-token:${n}`,"Content-Type":"application/json"},method:"GET"});if(!r.ok){const l=await r.text().catch(()=>"Unknown error");throw new Error(`Failed to get user info: ${l}`)}return await r.json()}const ae=g("inAppWallet"),ie=`${ae}/`,B=`${ie}api/2023-10-20`,ne=`${B}/embedded-wallet/validate-custom-jwt`,re=`${B}/embedded-wallet/validate-custom-auth-endpoint`,M=(n,e)=>e instanceof Error?`${n}: ${e.message}`:`${n}: ${w(e)}`;async function se(n){const t=await p(n.client,n.ecosystem)(re,{body:w({developerClientId:n.client.clientId,payload:n.payload}),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok){const a=await t.json();throw new Error(`Custom auth endpoint authentication error: ${a.message}`)}try{const{verifiedToken:a}=await t.json();return{storedToken:a}}catch(a){throw new Error(M("Malformed response from post auth_endpoint authentication",a))}}async function oe(n){const e=p(n.client,n.ecosystem),t=S({authOption:"backend",client:n.client,ecosystem:n.ecosystem}),a=await e(`${t}`,{body:w({walletSecret:n.walletSecret}),headers:{"Content-Type":"application/json"},method:"POST"});if(!a.ok){const r=await a.text();throw new Error(`Failed to generate backend account: ${r}`)}return await a.json()}async function ce(n){let e=await n.storage.getGuestSessionId();e||(e=x(32),n.storage.saveGuestSessionId(e));const t=p(n.client,n.ecosystem),a=A({authOption:"guest",client:n.client,ecosystem:n.ecosystem}),r=await t(`${a}`,{body:w({sessionId:e}),headers:{"Content-Type":"application/json"},method:"POST"});if(!r.ok){const l=await r.text();throw new Error(`Failed to generate guest account: ${r.status} ${r.statusText} ${l}`)}return await r.json()}async function le(n){const t=await p(n.client,n.ecosystem)(ne,{body:w({developerClientId:n.client.clientId,jwt:n.jwt}),headers:{"Content-Type":"application/json"},method:"POST"});if(!t.ok){const a=await t.json();throw new Error(`JWT authentication error: ${a.message}`)}try{const{verifiedToken:a}=await t.json();return{storedToken:a}}catch(a){throw new Error(M("Malformed response from post jwt authentication",a))}}function z(){return`${g("inAppWallet")}/api/2024-05-05/login/passkey/callback`}function R(n,e){return`${g("inAppWallet")}/api/2024-05-05/login/passkey?type=${n}${e?`&username=${e}`:""}`}async function ue(n){var u,h,d;if(!n.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=p(n.client,n.ecosystem),t=n.username??he(n.ecosystem),r=await(await e(R("sign-up",t))).json();if(!r.challenge)throw new Error("No challenge received");const l=r.challenge,o=await n.passkeyClient.register({challenge:l,name:t,rp:n.rp}),i={};(u=n.ecosystem)!=null&&u.partnerId&&(i["x-ecosystem-partner-id"]=n.ecosystem.partnerId),(h=n.ecosystem)!=null&&h.id&&(i["x-ecosystem-id"]=n.ecosystem.id);const s=await(await e(z(),{body:w({authenticatorData:o.authenticatorData,clientData:o.clientData,credential:{algorithm:o.credential.algorithm,publicKey:o.credential.publicKey},credentialId:o.credentialId,origin:o.origin,rpId:n.rp.id,serverVerificationId:r.serverVerificationId,type:"sign-up",username:t}),headers:{"Content-Type":"application/json",...i},method:"POST"})).json();if(!s||!s.storedToken)throw new Error(`Error verifying passkey: ${s.message??"unknown error"}`);return await((d=n.storage)==null?void 0:d.savePasskeyCredentialId(o.credentialId)),s}async function de(n){var s,u,h,d;if(!n.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=p(n.client,n.ecosystem),[t,a]=await Promise.all([e(R("sign-in")).then(y=>y.json()),(s=n.storage)==null?void 0:s.getPasskeyCredentialId()]);if(!t.challenge)throw new Error("No challenge received");const r=t.challenge,l=await n.passkeyClient.authenticate({challenge:r,credentialId:a??void 0,rp:n.rp}),o={};(u=n.ecosystem)!=null&&u.partnerId&&(o["x-ecosystem-partner-id"]=n.ecosystem.partnerId),(h=n.ecosystem)!=null&&h.id&&(o["x-ecosystem-id"]=n.ecosystem.id);const c=await(await e(z(),{body:w({authenticatorData:l.authenticatorData,clientData:l.clientData,credentialId:l.credentialId,origin:l.origin,rpId:n.rp.id,serverVerificationId:t.serverVerificationId,signature:l.signature,type:"sign-in"}),headers:{"Content-Type":"application/json",...o},method:"POST"})).json();if(!c||!c.storedToken)throw new Error(`Error verifying passkey: ${c.message??"unknown error"}`);return await((d=n.storage)==null?void 0:d.savePasskeyCredentialId(l.credentialId)),c}function he(n){return`${(n==null?void 0:n.id)??"wallet"}-${new Date().toISOString()}`}const we=["xyz.abs"];async function pe(n){const{wallet:e,client:t,ecosystem:a,chain:r}=n,l=we.includes(e.id)?r||I(1):I(1),o=e.getAccount()||await e.connect({chain:l,client:t}),i=p(t,a),c=await(async()=>{const h=S({authOption:"wallet",client:n.client,ecosystem:n.ecosystem}),d=await i(`${h}&address=${o.address}&chainId=${l.id}`);if(!d.ok)throw new Error("Failed to generate SIWE login payload");return await d.json()})(),{signature:s}=await ee({account:o,payload:c});return await(async()=>{const h=A({authOption:"wallet",client:n.client,ecosystem:n.ecosystem}),d=await i(`${h}&signature=${s}&payload=${encodeURIComponent(c)}`,{body:w({payload:c,signature:s}),headers:{"Content-Type":"application/json"},method:"POST"});if(!d.ok)throw new Error("Failed to verify SIWE signature");return await d.json()})()}async function ge({client:n,payload:e,storage:t}){const a=await t.getAuthCookie(),r=t.ecosystem,l=p(n,r);if(!a)throw new Error("No auth token found when signing message");const o={address:e.address,chainId:e.chainId,nonce:Number(e.nonce)},i=await l(`${g("inAppWallet")}/api/v1/enclave-wallet/sign-authorization`,{body:w(o),headers:{Authorization:`Bearer embedded-wallet-token:${a}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!i.ok)throw new Error(`Failed to sign message - ${i.status} ${i.statusText}`);return await i.json()}async function me({client:n,payload:{message:e,isRaw:t,originalMessage:a,chainId:r},storage:l}){const o=await l.getAuthCookie(),i=l.ecosystem,c=p(n,i);if(!o)throw new Error("No auth token found when signing message");const s=await c(`${g("inAppWallet")}/api/v1/enclave-wallet/sign-message`,{body:w({messagePayload:{chainId:r,isRaw:t,message:e,originalMessage:a}}),headers:{Authorization:`Bearer embedded-wallet-token:${o}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!s.ok)throw new Error(`Failed to sign message - ${s.status} ${s.statusText}`);return await s.json()}async function ye({client:n,payload:e,storage:t}){const a=await t.getAuthCookie(),r=t.ecosystem,l=p(n,r);if(!a)throw new Error("No auth token found when signing transaction");const o=await l(`${g("inAppWallet")}/api/v1/enclave-wallet/sign-transaction`,{body:w({transactionPayload:e}),headers:{Authorization:`Bearer embedded-wallet-token:${a}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!o.ok)throw new Error(`Failed to sign transaction - ${o.status} ${o.statusText}`);return(await o.json()).signature}async function fe({client:n,payload:e,storage:t}){const a=await t.getAuthCookie(),r=t.ecosystem,l=p(n,r);if(!a)throw new Error("No auth token found when signing typed data");const o=await l(`${g("inAppWallet")}/api/v1/enclave-wallet/sign-typed-data`,{body:w({...e}),headers:{Authorization:`Bearer embedded-wallet-token:${a}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!o.ok)throw new Error(`Failed to sign typed data - ${o.status} ${o.statusText}`);return await o.json()}class be{constructor({client:e,ecosystem:t,address:a,storage:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"address",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.address=a,this.localStorage=r}async postWalletSetUp(e){await this.localStorage.saveAuthCookie(e.storedToken.cookieString)}async getUserWalletStatus(){var l,o;const e=await this.localStorage.getAuthCookie();if(!e)return{status:"Logged Out"};const t=await W({authToken:e,client:this.client,ecosystem:this.ecosystem});if(!t)return{status:"Logged Out"};const a=t.wallets[0],r={email:(l=t.linkedAccounts.find(i=>i.details.email!==void 0))==null?void 0:l.details.email,phoneNumber:(o=t.linkedAccounts.find(i=>i.details.phone!==void 0))==null?void 0:o.details.phone,recoveryShareManagement:"ENCLAVE",userWalletId:t.id||""};return a?{account:await this.getAccount(),authDetails:r,status:"Logged In, Wallet Initialized",walletAddress:a.address}:{authDetails:r,status:"Logged In, Wallet Uninitialized"}}async getAccount(){const e=this.client,t=this.localStorage,a=this.address,r=this.ecosystem,l=async i=>{const c=L({chain:I(i.chainId),client:e}),s={chainId:P(i.chainId),data:i.data,gas:m(i.gas),nonce:m(i.nonce)||P(await b(async()=>{const{eth_getTransactionCount:u}=await import("./eth_getTransactionCount-CIEBEpFK.js");return{eth_getTransactionCount:u}},__vite__mapDeps([0,1,2])).then(({eth_getTransactionCount:u})=>u(c,{address:f(this.address),blockTag:"pending"}))),to:i.to?f(i.to):void 0,value:m(i.value)};return i.authorizationList&&i.authorizationList.length>0?(s.type=4,s.authorizationList=i.authorizationList,s.maxFeePerGas=m(i.maxFeePerGas),s.maxPriorityFeePerGas=m(i.maxPriorityFeePerGas)):m(i.maxFeePerGas)?(s.maxFeePerGas=m(i.maxFeePerGas),s.maxPriorityFeePerGas=m(i.maxPriorityFeePerGas),s.type=2):(s.gasPrice=m(i.gasPrice),s.type=0),ye({client:e,payload:s,storage:t})},o={address:f(a),async sendTransaction(i){const c=L({chain:I(i.chainId),client:e}),s=await l(i),u=await F(c,s);return $({chainId:i.chainId,client:e,contractAddress:i.to??void 0,ecosystem:r,gasPrice:i.gasPrice,transactionHash:u,walletAddress:a,walletType:"inApp"}),{transactionHash:u}},async signAuthorization(i){const c=await ge({client:e,payload:i,storage:t});return{address:f(c.address),chainId:Number.parseInt(c.chainId),nonce:BigInt(c.nonce),r:BigInt(c.r),s:BigInt(c.s),yParity:Number.parseInt(c.yParity)}},async signMessage({message:i,originalMessage:c,chainId:s}){const u=typeof i=="string"?{chainId:s,isRaw:!1,message:i,originalMessage:c}:{chainId:s,isRaw:!0,message:typeof i.raw=="string"?i.raw:V(i.raw),originalMessage:c},{signature:h}=await me({client:e,payload:u,storage:t});return h},async signTransaction(i){if(!i.chainId)throw new Error("chainId required in tx to sign");return l({chainId:i.chainId,...i})},async signTypedData(i){const c=D(i),{signature:s}=await fe({client:e,payload:c,storage:t});return s},sendCalls:async i=>{const{inAppWalletSendCalls:c}=await b(async()=>{const{inAppWalletSendCalls:y}=await import("./in-app-wallet-calls-C9G9WY2D.js");return{inAppWalletSendCalls:y}},__vite__mapDeps([3,1,2,4])),s=i.calls[0];if(!s)throw new Error("No calls to send");const u=s.client,h=s.chain||i.chain,d=await c({account:o,calls:i.calls,chain:h});return{chain:h,client:u,id:d}},getCallsStatus:async i=>{const{inAppWalletGetCallsStatus:c}=await b(async()=>{const{inAppWalletGetCallsStatus:s}=await import("./in-app-wallet-calls-C9G9WY2D.js");return{inAppWalletGetCallsStatus:s}},__vite__mapDeps([3,1,2,4]));return c(i)},getCallsStatusRaw:async i=>{const{inAppWalletGetCallsStatusRaw:c}=await b(async()=>{const{inAppWalletGetCallsStatusRaw:s}=await import("./in-app-wallet-calls-C9G9WY2D.js");return{inAppWalletGetCallsStatusRaw:s}},__vite__mapDeps([3,1,2,4]));return c(i)},getCapabilities:async i=>({[i.chainId??1]:{atomic:{status:"unsupported"},paymasterService:{supported:!1}}})};return o}}function m(n){return n===void 0||Q(n)?n:P(n)}const Ie={backgroundColor:"transparent",border:"none",colorScheme:"light",display:"none",height:"100%",pointerEvents:"all",position:"fixed",right:"0px",top:"0px",width:"100%",zIndex:"2147483646"},T=new Map;class ve{constructor({link:e,baseUrl:t,iframeId:a,container:r,onIframeInitialize:l,localStorage:o,clientId:i,ecosystem:c}){if(Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.localStorage=o,this.clientId=i,this.ecosystem=c,this.iframeBaseUrl=t,typeof document>"u")return;r=r??document.body;let s=document.getElementById(a);const u=new URL(e);if(!s||s.src!==u.href){s=document.createElement("iframe");const h={...Ie};Object.assign(s.style,h),s.setAttribute("id",a),s.setAttribute("fetchpriority","high"),r.appendChild(s),s.src=u.href;const d=y=>{if(y.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",d),!s){console.warn("thirdweb iFrame not found");return}this.onIframeLoadHandler(s,l)()}};window.addEventListener("message",d)}this.iframe=s}async onIframeLoadedInitVariables(){var e,t;return{authCookie:await this.localStorage.getAuthCookie(),clientId:this.clientId,deviceShareStored:await this.localStorage.getDeviceShare(),ecosystemId:(e=this.ecosystem)==null?void 0:e.id,partnerId:(t=this.ecosystem)==null?void 0:t.partnerId,walletUserId:await this.localStorage.getWalletUserId()}}onIframeLoadHandler(e,t){return async()=>{var l;const a=new MessageChannel,r=new Promise((o,i)=>{a.port1.onmessage=c=>{const{data:s}=c;a.port1.close(),s.success||i(new Error(s.error)),T.set(e.src,!0),t&&t(),o(!0)}});(l=e==null?void 0:e.contentWindow)==null||l.postMessage({data:await this.onIframeLoadedInitVariables(),eventType:"initIframe"},this.iframeBaseUrl,[a.port2]),await r}}async call({procedureName:e,params:t,showIframe:a=!1}){var o;if(!this.iframe)throw new Error("Iframe not found. You are likely calling this from the backend where the DOM is not available.");for(;!T.get(this.iframe.src);)await v(this.POLLING_INTERVAL_SECONDS*1e3);a&&(this.iframe.style.display="block",await v(.005*1e3));const r=new MessageChannel,l=new Promise((i,c)=>{r.port1.onmessage=async s=>{const{data:u}=s;r.port1.close(),a&&(await v(.1*1e3),this.iframe&&(this.iframe.style.display="none")),u.success?i(u.data):c(new Error(u.error))}});return(o=this.iframe.contentWindow)==null||o.postMessage({data:{...t,...await this.onIframeLoadedInitVariables()},eventType:e},this.iframeBaseUrl,[r.port2]),l}destroy(){this.iframe&&T.delete(this.iframe.src)}}class ke extends ve{constructor({clientId:e,baseUrl:t,ecosystem:a}){super({baseUrl:t,clientId:e,container:typeof document>"u"?void 0:document.body,ecosystem:a,iframeId:Le+((a==null?void 0:a.id)||""),link:Te({baseUrl:t,clientId:e,ecosystem:a,path:q}).href,localStorage:new N({clientId:e,ecosystem:a,storage:U})}),this.clientId=e,this.ecosystem=a}}function Te({clientId:n,baseUrl:e,path:t,ecosystem:a,queryParams:r}){var o;const l=new URL(`${t}`,e);if(r)for(const i of Object.keys(r))l.searchParams.set(i,((o=r[i])==null?void 0:o.toString())||"");return l.searchParams.set("clientId",n),(a==null?void 0:a.partnerId)!==void 0&&l.searchParams.set("partnerId",a.partnerId),(a==null?void 0:a.id)!==void 0&&l.searchParams.set("ecosystemId",a.id),l}const Le="thirdweb-in-app-wallet-iframe";async function Pe({client:n,ecosystem:e,authToken:t}){const r=await p(n,e)(`${g("inAppWallet")}/api/v1/enclave-wallet/generate`,{headers:{Authorization:`Bearer embedded-wallet-token:${t}`,"Content-Type":"application/json","x-thirdweb-client-id":n.clientId},method:"POST"});if(!r.ok)throw new Error(`Failed to generate wallet - ${r.status} ${r.statusText}`);const{wallet:l}=await r.json();return l}class Se{constructor({baseUrl:e,querier:t,preLogin:a,postLogin:r,client:l,ecosystem:o}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=t,this.preLogin=a,this.postLogin=r,this.client=l,this.ecosystem=o}async sendEmailLoginOtp({email:e}){return await this.LoginQuerier.call({params:{email:e},procedureName:"sendThirdwebEmailLoginOtp"})}async sendSmsLoginOtp({phoneNumber:e}){return await this.LoginQuerier.call({params:{phoneNumber:e},procedureName:"sendThirdwebSmsLoginOtp"})}}class Ae extends Se{async authenticateWithModal(){return this.LoginQuerier.call({params:void 0,procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithModal(){await this.preLogin();const e=await this.authenticateWithModal();return this.postLogin(e)}async authenticateWithIframe({email:e}){return this.LoginQuerier.call({params:{email:e},procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithIframe({email:e}){await this.preLogin();const t=await this.authenticateWithIframe({email:e});return this.postLogin(t)}async authenticateWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");return this.LoginQuerier.call({params:{encryptionKey:e,jwt:t},procedureName:"loginWithCustomJwt"})}async loginWithCustomJwt({encryptionKey:e,jwt:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");await this.preLogin();const a=await this.authenticateWithCustomJwt({encryptionKey:e,jwt:t});return this.postLogin(a)}async authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t}){return this.LoginQuerier.call({params:{encryptionKey:e,payload:t},procedureName:"loginWithCustomAuthEndpoint"})}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:t}){if(!e||e.length===0)throw new Error("Encryption key is required for custom auth");await this.preLogin();const a=await this.authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:t});return this.postLogin(a)}async authenticateWithEmailOtp({email:e,otp:t,recoveryCode:a}){return this.LoginQuerier.call({params:{email:e,otp:t,recoveryCode:a},procedureName:"verifyThirdwebEmailLoginOtp"})}async loginWithEmailOtp({email:e,otp:t,recoveryCode:a}){const r=await this.authenticateWithEmailOtp({email:e,otp:t,recoveryCode:a});return this.postLogin(r)}async authenticateWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:a}){return this.LoginQuerier.call({params:{otp:t,phoneNumber:e,recoveryCode:a},procedureName:"verifyThirdwebSmsLoginOtp"})}async loginWithSmsOtp({phoneNumber:e,otp:t,recoveryCode:a}){const r=await this.authenticateWithSmsOtp({otp:t,phoneNumber:e,recoveryCode:a});return this.postLogin(r)}}class We{constructor({client:e,querier:t,onAuthSuccess:a,ecosystem:r,baseUrl:l,localStorage:o}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=r,this.AuthQuerier=t,this.localStorage=o,this.onAuthSuccess=a,this.BaseLogin=new Ae({baseUrl:l,client:e,ecosystem:r,postLogin:async i=>this.postLogin(i),preLogin:async()=>{await this.preLogin()},querier:t})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:t})}async loginWithAuthToken(e,t){var l;e.storedToken.authProvider!=="Backend"&&await this.preLogin();const a=await W({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});if(!a)throw new Error("Cannot login, no user found for auth token");if(a.wallets.length>0&&((l=a.wallets[0])==null?void 0:l.type)==="enclave")return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:a.wallets[0].address}});if(a.wallets.length===0){const o=await Pe({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:o.address}})}const r=await this.AuthQuerier.call({params:{recoveryCode:t,storedToken:e.storedToken},procedureName:"loginWithStoredTokenDetails"});return this.postLogin(r)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async authenticateWithModal(){return this.BaseLogin.authenticateWithModal()}async loginWithIframe(e){return this.BaseLogin.loginWithIframe(e)}async authenticateWithIframe(e){return this.BaseLogin.authenticateWithIframe(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async authenticateWithCustomJwt(e){return this.BaseLogin.authenticateWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async authenticateWithCustomAuthEndpoint(e){return this.BaseLogin.authenticateWithCustomAuthEndpoint(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async loginWithEmailOtp(e){return await this.preLogin(),this.BaseLogin.loginWithEmailOtp(e)}async authenticateWithEmailOtp(e){return this.BaseLogin.authenticateWithEmailOtp(e)}async loginWithSmsOtp(e){return await this.preLogin(),this.BaseLogin.loginWithSmsOtp(e)}async authenticateWithSmsOtp(e){return this.BaseLogin.authenticateWithSmsOtp(e)}async logout(){const e=await this.localStorage.removeAuthCookie(),t=await this.localStorage.removeWalletUserId();return{success:e||t}}}const Ee=async n=>{const{client:e,ecosystem:t}=n,a=S({authOption:n.strategy,client:e,ecosystem:t}),r={"Content-Type":"application/json","x-client-id":e.clientId};t!=null&&t.id&&(r["x-ecosystem-id"]=t.id),t!=null&&t.partnerId&&(r["x-ecosystem-partner-id"]=t.partnerId);const l=(()=>{switch(n.strategy){case"email":return{email:n.email};case"phone":return{phone:n.phoneNumber}}})(),o=await fetch(a,{body:w(l),headers:r,method:"POST"});if(!o.ok){const i=await o.text();let c;try{const s=JSON.parse(i);s&&typeof s.message=="string"&&(c=s.message)}catch{}throw new Error(c||"Failed to send verification code")}return await o.json()},j=async n=>{const{client:e,ecosystem:t}=n,a=A({authOption:n.strategy,client:n.client,ecosystem:n.ecosystem}),r={"Content-Type":"application/json","x-client-id":e.clientId};t!=null&&t.id&&(r["x-ecosystem-id"]=t.id),t!=null&&t.partnerId&&(r["x-ecosystem-partner-id"]=t.partnerId);const l=(()=>{switch(n.strategy){case"email":return{code:n.verificationCode,email:n.email};case"phone":return{code:n.verificationCode,phone:n.phoneNumber}}})(),o=await fetch(a,{body:w(l),headers:r,method:"POST"});if(!o.ok)throw new Error("Failed to verify verification code");return await o.json()};class _{constructor({client:e,ecosystem:t,querier:a,localStorage:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=t,this.walletManagerQuerier=a,this.localStorage=r}async postWalletSetUp(e){e.deviceShareStored&&await this.localStorage.saveDeviceShare(e.deviceShareStored,e.storedToken.authDetails.userWalletId)}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({params:void 0,procedureName:"getUserStatus"});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",...e.user,account:await this.getAccount()}:e.status==="Logged In, New Device"?{status:"Logged In, New Device",...e.user}:e.status==="Logged In, Wallet Uninitialized"?{status:"Logged In, Wallet Uninitialized",...e.user}:{status:e.status}}async getAccount(){var o;const e=this.walletManagerQuerier,t=this.client,a=(o=this.ecosystem)==null?void 0:o.partnerId,{address:r}=await e.call({params:void 0,procedureName:"getAddress"}),l=async i=>{const c={chainId:i.chainId,data:i.data,gasLimit:i.gas,nonce:i.nonce,to:i.to??void 0,value:i.value};i.maxFeePerGas?(c.accessList=i.accessList,c.maxFeePerGas=i.maxFeePerGas,c.maxPriorityFeePerGas=i.maxPriorityFeePerGas,c.type=2):(c.gasPrice=i.gasPrice,c.type=0);const s=O().rpc,{signedTransaction:u}=await e.call({params:{chainId:i.chainId,partnerId:a,rpcEndpoint:`https://${i.chainId}.${s}`,transaction:c},procedureName:"signTransaction"});return u};return{address:f(r),async sendTransaction(i){const c=L({chain:I(i.chainId),client:t}),s=await l(i),u=await F(c,s);return $({chainId:i.chainId,client:t,contractAddress:i.to??void 0,gasPrice:i.gasPrice,transactionHash:u,walletAddress:r,walletType:"inApp"}),{transactionHash:u}},async signMessage({message:i}){const c=typeof i=="string"?i:i.raw instanceof Uint8Array?i.raw:H(i.raw),{signedMessage:s}=await e.call({params:{chainId:1,message:c,partnerId:a},procedureName:"signMessage"});return s},async signTransaction(i){if(!i.chainId)throw new Error("chainId required in tx to sign");return l({...i,chainId:i.chainId})},async signTypedData(i){var E;const c=D(i);(E=c.types)!=null&&E.EIP712Domain&&(c.types.EIP712Domain=void 0);const s=c.domain,u=s==null?void 0:s.chainId,d={...s!=null&&s.verifyingContract?{verifyingContract:s==null?void 0:s.verifyingContract}:{},name:s==null?void 0:s.name,version:s==null?void 0:s.version};u&&(d.chainId=u);const y=O().rpc,{signedTypedData:G}=await e.call({params:{chainId:Number.parseInt(BigInt(u||1).toString()),domain:d,message:c.message,partnerId:a,rpcEndpoint:`https://${u}.${y}`,types:c.types},procedureName:"signTypedDataV4"});return G}}}}class $e{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:t,ecosystem:a,passkeyDomain:r,storage:l}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passkeyDomain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const o=g("inAppWallet");this.client=e,this.ecosystem=a,this.passkeyDomain=r,this.storage=new N({clientId:e.clientId,ecosystem:a,storage:l??Ce()}),this.querier=new ke({baseUrl:o,clientId:e.clientId,ecosystem:a}),this.auth=new We({baseUrl:o,client:e,ecosystem:a,localStorage:this.storage,onAuthSuccess:async i=>{if(t==null||t(i),i.storedToken.authDetails.walletType==="sharded"&&(await this.querier.call({params:{storedToken:i.storedToken},procedureName:"migrateFromShardToEnclave"})||console.warn("Failed to migrate from sharded to enclave wallet, continuing with sharded wallet")),this.wallet=await this.initializeWallet(i.storedToken.cookieString),!this.wallet)throw new Error("Failed to initialize wallet");const c="deviceShareStored"in i.walletDetails?i.walletDetails.deviceShareStored:void 0;return await this.wallet.postWalletSetUp({deviceShareStored:c,storedToken:i.storedToken}),this.wallet instanceof _&&await this.querier.call({params:{authCookie:i.storedToken.cookieString,clientId:this.client.clientId,deviceShareStored:"deviceShareStored"in i.walletDetails?i.walletDetails.deviceShareStored:null,ecosystemId:a==null?void 0:a.id,partnerId:a==null?void 0:a.partnerId,walletUserId:i.storedToken.authDetails.userWalletId},procedureName:"initIframe"}),{user:{account:await this.wallet.getAccount(),authDetails:i.storedToken.authDetails,status:"Logged In, Wallet Initialized",walletAddress:i.walletDetails.walletAddress}}},querier:this.querier})}async initializeWallet(e){var r;const t=await this.storage.getAuthCookie();if(!e&&t===null)throw new Error("No auth token provided and no stored auth token found to initialize the wallet");const a=await W({authToken:e||t,client:this.client,ecosystem:this.ecosystem});if(!a)throw new Error("Cannot initialize wallet, no user logged in");if(a.wallets.length===0)throw new Error("Cannot initialize wallet, this user does not have a wallet generated yet");return((r=a.wallets[0])==null?void 0:r.type)==="enclave"?new be({address:a.wallets[0].address,client:this.client,ecosystem:this.ecosystem,storage:this.storage}):new _({client:this.client,ecosystem:this.ecosystem,localStorage:this.storage,querier:this.querier})}async getUser(){if(!this.wallet){const e=await this.storage.getAuthCookie();if(!e)return{status:"Logged Out"};this.wallet=await this.initializeWallet(e)}if(!this.wallet)throw new Error("Wallet not initialized");return await this.wallet.getUserWalletStatus()}getAccount(){if(!this.wallet)throw new Error("Wallet not initialized");return this.wallet.getAccount()}async preAuthenticate(e){return Ee({...e,client:this.client,ecosystem:this.ecosystem})}async authenticateWithRedirect(e,t,a){return C({authOption:e,client:this.client,ecosystem:this.ecosystem,mode:t,redirectUrl:a})}async loginWithAuthToken(e,t){return this.auth.loginWithAuthToken(e,t)}async authenticate(e){const t=e.strategy;switch(t){case"email":return j({...e,client:this.client,ecosystem:this.ecosystem});case"phone":return j({...e,client:this.client,ecosystem:this.ecosystem});case"auth_endpoint":return se({client:this.client,ecosystem:this.ecosystem,payload:e.payload});case"jwt":return le({client:this.client,ecosystem:this.ecosystem,jwt:e.jwt});case"passkey":return this.passkeyAuth(e);case"iframe_email_verification":return this.auth.authenticateWithIframe({email:e.email});case"iframe":return this.auth.authenticateWithModal();case"apple":case"facebook":case"google":case"telegram":case"github":case"twitch":case"farcaster":case"line":case"x":case"tiktok":case"epic":case"steam":case"coinbase":case"discord":return J({authOption:t,client:this.client,closeOpenedWindow:e.closeOpenedWindow,ecosystem:this.ecosystem,openedWindow:e.openedWindow});case"guest":return ce({client:this.client,ecosystem:this.ecosystem,storage:this.storage});case"backend":return oe({client:this.client,ecosystem:this.ecosystem,walletSecret:e.walletSecret});case"wallet":return pe({client:this.client,ecosystem:this.ecosystem,wallet:e.wallet,chain:e.chain})}}async connect(e){const t=e.strategy;switch(t){case"auth_endpoint":case"jwt":{const a=await this.authenticate(e);return await this.loginWithAuthToken(a,e.encryptionKey)}case"iframe_email_verification":return this.auth.loginWithIframe({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{const a=await this.passkeyAuth(e);return this.loginWithAuthToken(a)}case"backend":case"phone":case"email":case"wallet":case"apple":case"facebook":case"google":case"farcaster":case"telegram":case"github":case"line":case"x":case"tiktok":case"epic":case"guest":case"coinbase":case"twitch":case"steam":case"discord":{const a=await this.authenticate(e);return await this.auth.loginWithAuthToken(a)}default:Oe(t)}}async logout(){return await this.auth.logout()}async passkeyAuth(e){const{PasskeyWebClient:t}=await b(async()=>{const{PasskeyWebClient:i}=await import("./index-B7UgA71q.js").then(c=>c.eO);return{PasskeyWebClient:i}},__vite__mapDeps([1,2])),{passkeyName:a,storeLastUsedPasskey:r=!0}=e,l=new t,o=this.storage;return e.type==="sign-up"?ue({client:this.client,ecosystem:this.ecosystem,passkeyClient:l,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:r?o:void 0,username:a}):de({client:this.client,ecosystem:this.ecosystem,passkeyClient:l,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:r?o:void 0})}async linkProfileWithRedirect(e,t,a){return C({authOption:e,client:this.client,ecosystem:this.ecosystem,mode:t,redirectUrl:a,authFlow:"link"})}async linkProfile(e){if("strategy"in e&&Y.includes(e.strategy)&&"mode"in e&&e.mode!=="popup"&&e.mode!==void 0)return await this.linkProfileWithRedirect(e.strategy,e.mode,"redirectUrl"in e?e.redirectUrl:void 0),[];const{storedToken:t}=await this.authenticate(e);return await K({client:e.client,ecosystem:e.ecosystem||this.ecosystem,storage:this.storage,tokenToLink:t.cookieString})}async unlinkProfile(e,t){return await X({allowAccountDeletion:t,client:this.client,ecosystem:this.ecosystem,profileToUnlink:e,storage:this.storage})}async getProfiles(){return Z({client:this.client,ecosystem:this.ecosystem,storage:this.storage})}}function Oe(n,e){throw new Error(`Invalid param: ${n}`)}function Ce(){return typeof window<"u"&&window.localStorage?U:te}export{$e as InAppWebConnector};
